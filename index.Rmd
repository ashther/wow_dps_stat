---
title: "wow dps statistic"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
# runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(ggplot2)
library(plotly)

bayes_mean <- function(dps, n) {
  dps * n / (n + mean(n)) + mean(dps) * mean(n) / (n + mean(n))
}

pal_wow <- c(
  'Hunter' = '#A9D271',
  'Shaman' = '#0070DE',
  'Warlock' = '#8787ED',
  'Mage' = '#40C7EB',
  'DeathKnight' = '#C41F3B',
  'Death Knight' = '#C41F3B',
  'Warrior' = '#C79C6E',
  'Druid' = '#FF7D0A',
  'DemonHunter' = '#A330C9',
  'Demon Hunter' = '#A330C9',
  'Priest' = '#FFFFFF',
  'Paladin' = '#F58CBA',
  'Rogue' = '#FFF569',
  'Monk' = '#00FF96',
  'Other' = 'grey',

  'hunter' = '#A9D271',
  'shaman' = '#0070DE',
  'warlock' = '#8787ED',
  'mage' = '#40C7EB',
  'deathknight' = '#C41F3B',
  'death knight' = '#C41F3B',
  'warrior' = '#C79C6E',
  'druid' = '#FF7D0A',
  'demonhunter' = '#A330C9',
  'demon hunter' = '#A330C9',
  'priest' = '#FFFFFF',
  'paladin' = '#F58CBA',
  'rogue' = '#FFF569',
  'monk' = '#00FF96',
  'other' = 'grey'
)

pal_covenant <- c(
  'nightfae' = '#c851ec',
  'venthyr' = '#e02d2d',
  'kyrian' = '#a9dcfc',
  'necrolord' = '#96b364'
)

wcl <- readRDS('wcl.rds')
file_info <- file.info('wcl.rds')
report <- wcl$report %>% 
  tidyr::unnest(report) %>% 
  filter(
    !is.na(class), 
    !is.na(spec), 
    !stringr::str_detect(
      spec,
      'Holy|Restoration|Mistweaver|Protection|Blood|Vengeance|Discipline|Guardian|unknown|,')
  )

q <- 0.75
```

Row
-----------------------------------------------------------------------

### Players
```{r}
valueBox(n_distinct(report$name), color = '#3d98d3')
```

### Dps Median
```{r}
valueBox(median(report$dps, na.rm = TRUE), color = '#f9791e')
```

### Ilvl Median
```{r}
valueBox(median(report$ilvl, na.rm = TRUE), color = '#5e35b1')
```

Row {data-height=800}
-----------------------------------------------------------------------

### Damage Per Second

```{r}
# data <- report %>% 
#   select(class, spec, dps) %>% {
#     dat <- .
#     temp <- group_by(dat, class, spec) %>% 
#       summarise(
#         dps_median = quantile(dps, q, na.rm = TRUE), 
#         n = n(), 
#         .groups = 'drop'
#       )
#     right_join(temp, dat, by = c('class', 'spec'))
#   } %>% 
#   mutate(name = paste(class, spec))
# 
# tibble::enframe(pal_wow) %>% 
#   right_join(data, by = c('name' = 'class')) %>% {
#     . <- .[order(.$dps_median), ]
#     .$name.y <- factor(.$name.y, levels = as.character(unique(.$name.y)))
#     .
#   } %>% 
#   plot_ly(
#     x = ~ dps, 
#     y = ~ name.y, 
#     type = 'box', 
#     color= ~name, 
#     colors = pal_wow, 
#     hoverinfo = 'y'
#   ) %>% 
#   hide_legend()

data <- report %>%
  select(class, spec, dps) %>% {
    dat <- .
    
    temp <- group_by(dat, class, spec) %>%
      summarise(
        dps_median = quantile(dps, probs = q, na.rm = TRUE),
        text_pos = quantile(dps, 0.75, na.rm = TRUE), 
        n = n(),
        .groups = 'drop'
      )
    temp <- mutate(temp, dps_median = bayes_mean(dps_median, n))
    
    right_join(temp, dat, by = c('class', 'spec'))
  } %>%
  mutate(name = paste(class, spec))

p <- data %>% 
  ggplot(aes(reorder(name, dps_median), dps)) +
  geom_boxplot(aes(fill = class), color = 'grey', alpha = 1, show.legend = FALSE) + 
  geom_text(data = distinct(data, name, dps_median, spec), aes(name, dps_median, label = spec), nudge_y = 300, alpha = 0.6, size = 3) + 
  coord_flip() + 
  scale_fill_manual(values = pal_wow) + 
  theme_minimal() + 
  labs(x = NULL)

ggplotly(p) %>% 
  layout(showlegend = FALSE, yaxis = list(showticklabels = FALSE))
  
```

Row 
-----------------------------------------------------------------------

### Variance

```{r}
data <- report %>%
  mutate(
    dps_all = quantile(dps, q, na.rm = TRUE),
    var_all = var(dps, na.rm = TRUE)
  ) %>%
  group_by(class, spec, dps_all, var_all) %>%
  summarise(
    var = var(dps, na.rm = TRUE),
    dps = quantile(dps, q, na.rm = TRUE),
    n = n(),
    .groups = 'drop'
  )

p <- data %>% 
  ggplot(aes(dps, var)) +
  geom_point(aes(size = n ^ 2, color = class), show.legend = FALSE) +
  geom_hline(aes(yintercept = var_all), linetype = 'dashed', color = 'grey') +
  geom_vline(aes(xintercept = dps_all), linetype = 'dashed', color = 'grey') +
  geom_text(aes(dps, var, label = spec), alpha = 0.6, size = 3) + 
  scale_y_continuous(labels = function(x)format(x, scientific = TRUE)) +
  scale_color_manual(values = pal_wow) + 
  theme_minimal()

ggplotly(p, tooltip = 'class') %>% 
  layout(showlegend = FALSE)

```

### Hunter's Covenant

```{r}
# data <- transmute(report, name = paste(class, spec), url_report) %>% 
#   widyr::pairwise_count(name, url_report) %>% 
#   filter(n >= quantile(n, 0.8))
# net <- graph_from_data_frame(data, directed = FALSE)
# E(net)$weight <- 1 / E(net)$n
# 
# eg <- evcent(net, directed = FALSE, weights = E(net)$n)$vector
# members <- membership(cluster_fast_greedy(simplify(net)))
# 
# net_d3 <- networkD3::igraph_to_networkD3(net, group = members)
# 
# networkD3::forceNetwork(Links = net_d3$links, Nodes = net_d3$nodes, 
#              Source = 'source', Target = 'target', 
#              NodeID = 'name', Group = 'group', zoom = TRUE)

# p <- ggraph(net) + 
#   geom_edge_link(aes(edge_alpha = 1 / weight), show.legend = FALSE) + 
#   geom_node_point(aes(size = eg), show.legend = FALSE) + 
#   geom_node_text(aes(label = V(net)$name), repel = TRUE, show.legend = FALSE) + 
#   theme_minimal()

data <- filter(report, class == 'Hunter') %>% 
  mutate(dps_all = quantile(dps, q, na.rm = TRUE), 
         var_all = var(dps, na.rm = TRUE)) %>% 
  group_by(spec, covenant, dps_all, var_all) %>% 
  summarise(var = var(dps, na.rm = TRUE), 
            dps = quantile(dps, q, na.rm = TRUE), 
            n = n(), 
            .groups = 'drop')

p <- data %>% 
  ggplot(aes(dps, var, label = spec)) +
  geom_point(aes(size = n, color = covenant), show.legend = FALSE) +
  geom_hline(aes(yintercept = var_all), linetype = 'dashed', color = 'grey') +
  geom_vline(aes(xintercept = dps_all), linetype = 'dashed', color = 'grey') +
  geom_text(aes(dps, var, label = spec), alpha = 0.6, size = 3) + 
  scale_y_continuous(labels = function(x)format(x, scientific = TRUE)) +
  scale_color_manual(values = pal_covenant) + 
  theme_minimal()

ggplotly(p, tooltip = 'label') %>% 
  layout(showlegend = FALSE)

```


Row {data-height=20} 
-----------------------------------------------------------------------
```{r}
sprintf('data updated on %s', file_info$mtime)
```

